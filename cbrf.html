<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Курсы валют ЦБ РФ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.3.2/css/flag-icons.min.css" />
    <style>
        html, body {
            margin: 0; 
            padding: 0; 
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        body {
            background: url('https://i.postimg.cc/NFNgHnkF/image.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #cce7f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(2,24,36,0.75);
            z-index: 0;
        }

        h1 {
            margin: 25px 0 15px;
            font-size: 2.4em;
            font-weight: 700;
            color: #d9f0ff;
            text-shadow: 2px 2px 5px #001f3f;
            position: relative;
            z-index: 1;
            animation: titleFadeIn 1s ease-out;
        }

        @keyframes titleFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        table {
            width: 70%;
            max-width: 1400px;
            border-collapse: collapse;
            background: rgba(3,44,60,0.85);
            box-shadow: 0 6px 30px rgba(0,0,0,0.7);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            z-index: 1;
            animation: tableFadeIn 1.2s ease-out 0.3s both;
            transition: all 0.3s ease;
        }

        @keyframes tableFadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        th, td {
            padding: 20px;
            font-size: 1.4em;
            line-height: 1.5;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            transition: all 0.3s ease;
        }

        th {
            background: rgba(10,80,120,0.85);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #b3d7f7;
            text-shadow: 1px 1px 2px #003450;
            text-align: left;
        }

        td:nth-child(1) {
            text-align: left;
        }
        td:nth-child(2) {
            text-align: center;
        }
        td:nth-child(3) {
            text-align: right;
        }

        tr {
            opacity: 0;
            transform: translateX(-20px);
            animation: rowSlideIn 0.6s ease-out forwards;
        }

        tr:nth-child(1) { animation-delay: 0.1s; }
        tr:nth-child(2) { animation-delay: 0.2s; }
        tr:nth-child(3) { animation-delay: 0.3s; }
        tr:nth-child(4) { animation-delay: 0.4s; }
        tr:nth-child(5) { animation-delay: 0.5s; }
        tr:nth-child(6) { animation-delay: 0.6s; }
        tr:nth-child(7) { animation-delay: 0.7s; }
        tr:nth-child(8) { animation-delay: 0.8s; }
        tr:nth-child(9) { animation-delay: 0.9s; }
        tr:nth-child(10) { animation-delay: 1.0s; }

        @keyframes rowSlideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        tr:nth-child(even) {
            background-color: rgba(255,255,255,0.05);
        }

        tr:hover {
            background-color: rgba(255,255,255,0.15);
            cursor: default;
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .flag {
            margin-right: 12px;
            vertical-align: middle;
            transition: transform 0.3s ease;
        }

        tr:hover .flag {
            transform: scale(1.1);
        }

        .currency-symbol {
            font-size: 1em;
            font-weight: 600;
            margin-right: 6px;
            color: #cce7f0;
            display: inline-block;
            transition: all 0.3s ease;
        }

        tr:hover .currency-symbol {
            transform: scale(1.05);
        }

        .rate-cell {
            font-weight: 600;
            transition: all 0.5s ease;
            position: relative;
        }

        .rate-updating {
            animation: rateUpdate 0.8s ease-in-out;
        }

        @keyframes rateUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: rgba(255,255,255,0.2); }
            100% { transform: scale(1); }
        }

        .diff-positive {
            color: #7bd87b;
            font-weight: 600;
            animation: positiveGlow 2s ease-in-out;
        }

        .diff-negative {
            color: #f25c5c;
            font-weight: 600;
            animation: negativeGlow 2s ease-in-out;
        }

        @keyframes positiveGlow {
            0%, 100% { text-shadow: none; }
            50% { text-shadow: 0 0 10px #7bd87b; }
        }

        @keyframes negativeGlow {
            0%, 100% { text-shadow: none; }
            50% { text-shadow: 0 0 10px #f25c5c; }
        }

        tfoot td {
            padding: 16px 18px;
            font-size: 1.2em;
            text-align: center;
            background: rgba(10,80,120,0.85);
            color: #a6d0f4;
            font-style: italic;
            text-shadow: 1px 1px 2px #003450;
        }

        /* Анимация загрузки */
        .loading {
            text-align: center;
            font-style: italic;
            color: #a6d0f4;
            position: relative;
            animation: loadingPulse 1.5s ease-in-out infinite;
            user-select: none;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #a6d0f4;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Анимация обновления данных */
        .updating {
            animation: tableUpdate 1s ease-in-out;
        }

        @keyframes tableUpdate {
            0% { opacity: 1; }
            50% { opacity: 0.7; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Индикатор последнего обновления */
        .last-updated {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10,80,120,0.9);
            color: #b3d7f7;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
            animation: updateIndicator 0.5s ease-out;
            display: none;
        }

        @keyframes updateIndicator {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="last-updated" id="lastUpdated">
        Обновлено: <span id="updateTime"></span>
    </div>
    
    <h1>Курсы валют ЦБ РФ</h1>
    
    <table id="ratesTable">
        <thead>
            <tr>
                <th>Валюта</th>
                <th>Курс</th>
                <th>±%</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3" class="loading">Загрузка данных</td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" id="currentDate"></td>
            </tr>
        </tfoot>
    </table>

    <script>
        const orderedCodes = ["USD", "EUR", "GBP", "JPY", "CHF", "CNY", "TRY", "HKD", "AED", "INR"];
        
        const flagMap = {
            USD: "us", 
            EUR: "eu", 
            GBP: "gb", 
            JPY: "jp", 
            CHF: "ch", 
            CNY: "cn", 
            TRY: "tr", 
            HKD: "hk", 
            AED: "ae", 
            INR: "in"
        };

        const currencySymbols = {
            USD: "$", 
            EUR: "€", 
            GBP: "£", 
            JPY: "¥", 
            CHF: "₣", 
            CNY: "¥", 
            TRY: "₺", 
            HKD: "HK$", 
            AED: "د.إ", 
            INR: "₹"
        };

        // Для хранения предыдущих курсов для анимации
        let previousRates = {};
        let isFirstLoad = true;

        function formatDateCBR(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getLastWorkingDay(date) {
            const d = new Date(date);
            let day = d.getDay();
            if (day === 0) d.setDate(d.getDate() - 2); // Sunday -> Friday
            else if (day === 6) d.setDate(d.getDate() - 1); // Saturday -> Friday
            return d;
        }

        async function fetchXML(url) {
            const proxyUrl = 'https://kurscbrf.free.nf/New1/proxy.php?url=' + encodeURIComponent(url);
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
            const buffer = await response.arrayBuffer();
            const text = new TextDecoder('windows-1251').decode(buffer);
            return new DOMParser().parseFromString(text, "text/xml");
        }

        // Функция анимации чисел: плавно считать от start до end за duration мс
        function animateValue(element, start, end, duration = 1000) {
            const startTimestamp = performance.now();
            element.classList.add('rate-updating');
            
            const step = (timestamp) => {
                let progress = (timestamp - startTimestamp) / duration;
                if (progress > 1) progress = 1;
                
                const value = start + (end - start) * progress;
                element.textContent = value.toFixed(4).replace('.', ',');
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    element.classList.remove('rate-updating');
                }
            };
            
            requestAnimationFrame(step);
        }

        function showUpdateIndicator() {
            const indicator = document.getElementById('lastUpdated');
            const timeSpan = document.getElementById('updateTime');
            const now = new Date();
            
            timeSpan.textContent = now.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            indicator.style.display = 'block';
            
            // Скрыть через 3 секунды
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        async function loadAll() {
            try {
                const table = document.getElementById('ratesTable');
                const body = table.querySelector('tbody');
                
                if (!isFirstLoad) {
                    table.classList.add('updating');
                    showUpdateIndicator();
                }
                
                if (isFirstLoad) {
                    body.innerHTML = '<tr><td colspan="3" class="loading">Загрузка данных</td></tr>';
                }

                let today = getLastWorkingDay(new Date());
                let yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday = getLastWorkingDay(yesterday);

                const [xmlToday, xmlYest] = await Promise.all([
                    fetchXML(`https://www.cbr.ru/scripts/XML_daily.asp?date_req=${formatDateCBR(today)}`),
                    fetchXML(`https://www.cbr.ru/scripts/XML_daily.asp?date_req=${formatDateCBR(yesterday)}`)
                ]);

                if (isFirstLoad) {
                    body.innerHTML = "";
                }

                orderedCodes.forEach((code, index) => {
                    const vToday = Array.from(xmlToday.getElementsByTagName("Valute"))
                        .find(v => v.querySelector("CharCode").textContent === code);
                    const vYest = Array.from(xmlYest.getElementsByTagName("Valute"))
                        .find(v => v.querySelector("CharCode").textContent === code);

                    if (!vToday || !vYest) return;

                    const name = vToday.querySelector("Name").textContent;
                    const rateToday = parseFloat(vToday.querySelector("Value").textContent.replace(",", ".")) /
                                    parseInt(vToday.querySelector("Nominal").textContent, 10);
                    const rateYest = parseFloat(vYest.querySelector("Value").textContent.replace(",", ".")) /
                                   parseInt(vYest.querySelector("Nominal").textContent, 10);

                    const diff = ((rateToday - rateYest) / rateYest) * 100;
                    const diffFixed = diff.toFixed(2);
                    const diffClass = diff >= 0 ? "diff-positive" : "diff-negative";

                    if (isFirstLoad) {
                        const tr = document.createElement("tr");
                        tr.style.animationDelay = `${index * 0.1}s`;

                        const tdName = document.createElement("td");
                        const symbol = currencySymbols[code] || '';
                        tdName.innerHTML = `<span class="flag fi fi-${flagMap[code]}"></span><span class="currency-symbol">${symbol}</span>${code} — ${name}`;

                        const tdRate = document.createElement("td");
                        tdRate.className = "rate-cell";
                        tdRate.textContent = "0,0000";

                        const tdDiff = document.createElement("td");
                        tdDiff.className = diffClass;
                        tdDiff.textContent = `${diffFixed}%`;

                        tr.appendChild(tdName);
                        tr.appendChild(tdRate);
                        tr.appendChild(tdDiff);
                        body.appendChild(tr);

                        // Анимируем изменение значения курса
                        const prevRate = previousRates[code] ?? 0;
                        animateValue(tdRate, prevRate, rateToday, 1200);
                    } else {
                        // Обновляем существующие данные
                        const rows = body.querySelectorAll('tr');
                        const row = rows[index];
                        if (row) {
                            const rateCell = row.querySelector('.rate-cell');
                            const diffCell = row.children[2];
                            
                            // Анимируем изменение курса
                            const prevRate = previousRates[code] ?? rateToday;
                            animateValue(rateCell, prevRate, rateToday, 800);
                            
                            // Обновляем разность
                            diffCell.className = diffClass;
                            diffCell.textContent = `${diffFixed}%`;
                        }
                    }

                    previousRates[code] = rateToday;
                });

                document.getElementById("currentDate").textContent = `Дата обновления: ${today.toLocaleDateString("ru-RU", {
                    year: "numeric", 
                    month: "long", 
                    day: "numeric"
                })}`;

                if (!isFirstLoad) {
                    setTimeout(() => {
                        table.classList.remove('updating');
                    }, 1000);
                }

                isFirstLoad = false;

            } catch (e) {
                console.error("Ошибка загрузки курсов:", e);
                const body = document.querySelector("#ratesTable tbody");
                body.innerHTML = `<tr><td colspan="3" style="color: #f25c5c; text-align:center;">Ошибка загрузки данных: ${e.message}</td></tr>`;
            }
        }

        loadAll();
        setInterval(loadAll, 3600000); // Обновление каждый час

        document.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        }, { once: true });
    </script>
</body>
</html>
